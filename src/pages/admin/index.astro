---
import EventManager from "../../components/EventManager";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { securityAudit } from "../../utils/securityAudit";
import fs from "fs";
import path from "path";

export const prerender = false;

// V√©rifie la session et le r√¥le admin
const audit = securityAudit(Astro.cookies, "admin");

if (!audit.authorized) {
  return Astro.redirect("/login");
}

const user = audit.user;

// Charge les √©v√©nements c√¥t√© serveur depuis src/data/events.json
const eventsFile = path.resolve("src/data/events.json");
const events = fs.existsSync(eventsFile)
  ? JSON.parse(fs.readFileSync(eventsFile, "utf-8"))
  : [];
---

<BaseLayout title="Admin √©v√©nements">
  <h1>üîß Gestion des √©v√©nements</h1>

  {user ? (
    <p>Connect√© en tant que : {user.username} (r√¥le : {user.role})</p>
  ) : (
    <p style={{ color: "red" }}>Utilisateur non reconnu.</p>
  )}

  <EventManager initialEvents={events} client:only="preact" />
</BaseLayout>